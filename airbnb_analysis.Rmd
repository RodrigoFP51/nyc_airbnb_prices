---
title: "NYC Airbnb Data Analysis"
author: "Rodrigo F. Pizzinato"
date: '`r format(Sys.Date(), "%d/%m/%Y")`'
output: 
  html_document:
  keep_md: true
  toc: true
  toc_depth: 2
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      error = FALSE, 
                      fig.width = 9)
```

```{r}
library(tidyverse)
library(here)
library(tidytext)
library(tidylo)
library(ppsr)
library(ggthemes)
library(DataExplorer)
library(paletteer)
library(patchwork)

theme_set(
  ggthemes::theme_gdocs()
)
```

```{r}
airbnb <- read_csv(here("Data/train.csv")) %>% 
  mutate(across(c(host_id, id), as.character))
```

## Dados faltantes
```{r}
airbnb %>% 
  plot_missing()
```

```{r}
skimr::skim(airbnb)
```

## distribuição das variáveis numéricas
```{r, fig.height=12}
g1 <- airbnb %>% 
  select(where(is.numeric), -price) %>% 
  pivot_longer(everything()) %>% 
  drop_na() %>% 
  ggplot(aes(value)) + 
  geom_histogram(fill = "#003366", color = "white", bins = 25, alpha = 0.75) +
  facet_wrap(vars(name), scales = "free") +
  labs(x='')

g2 <- airbnb %>% 
  ggplot(aes(price)) + 
  geom_histogram(fill = "#003366", color = "black", bins = 25, alpha = 0.75) +
  scale_x_continuous(labels = scales::dollar) +
  labs(x='')
  ggtitle("Price")

(g2 / g1) + patchwork::plot_annotation(title = "Distribution of Numerical Variables")
```

- Talvez o preço se beneficie com uma transformação logarítmica 

```{r}
g2 +
  scale_x_log10()
```

- Se assemelhou muito a uma distribuição normal, portanto usarei logaritmo para a modelagem e alguns gráficos.   

```{r}
rm(g1,g2)
```

```{r}
plot_grouped_distributions <- function(data,
                                       group,
                                       palette = "nord::afternoon_prarie"){
  data %>% 
  ggplot(aes(price+1, {{group}}, # + 1 pra não ter valores zerados no preço
             fill = factor(stat(quantile)))) + 
  ggridges::stat_density_ridges(
    geom = "density_ridges_gradient",
    quantiles = 5, quantile_lines = TRUE,
    alpha = 0.8
  ) +
  geom_vline(xintercept = median(data$price), 
             lty = 2,
             linewidth = 1.5, 
             alpha = 0.75,
             color = "gray40") +
  scale_fill_paletteer_d(palette, name = "Quintil") +
  scale_x_log10(labels = scales::dollar) +
  labs(x='', y='')
}

airbnb %>% 
  mutate(neighbourhood_group = fct_reorder(neighbourhood_group, price)) %>% 
  filter(between(price, 10, 1000)) %>% 
  plot_grouped_distributions(neighbourhood_group, "miscpalettes::pastel")

```


```{r}
airbnb %>% 
  filter(between(price, 10, 1000)) %>% 
  plot_grouped_distributions(room_type)
```

```{r}
airbnb %>% 
  filter(between(price, 10, 1000)) %>% 
  mutate(neighbourhood = fct_lump(neighbourhood, n = 9),
         neighbourhood = fct_reorder(neighbourhood, price)) %>% 
  plot_grouped_distributions(neighbourhood)
```
## Predictive Power Score

```{r}
pps <- airbnb %>% 
  select(-name, -host_name, -ends_with("id")) %>% 
  mutate(neighbourhood = fct_lump(neighbourhood, n = 9)) %>% 
  drop_na() %>% 
  ppsr::score_predictors(y = "price") %>% 
  filter(!is.na(baseline_score))

corr_features <- corrr::correlate(airbnb) %>% 
  select(corr = price, term) %>% 
  drop_na()

g1 <- pps %>% 
  mutate(x = fct_reorder(x, pps)) %>% 
  ggplot(aes(x,pps, fill = pps)) +
  geom_col() +
  scale_fill_gradient(low = "#6497b1", high = "#011f4b") +
  coord_flip() +
  labs(x='',y='') +
  ggtitle("Predictive Power Score")

g2 <- corr_features %>% 
  ggplot(aes(term, corr, fill = corr)) +
  geom_col() +
  scale_fill_gradient(low = "#6497b1", high = "#011f4b") +
  coord_flip() +
  ggtitle("Correlação: Pearson") +
  labs(x='',y='') 

(g1 / g2)
```
```{r}
airbnb_tokens <- airbnb %>% 
  unnest_tokens(word, name) %>% 
  anti_join(stop_words, by = "word") %>% 
  filter(str_detect(word, regex("^<U|[:digit:]"), negate = TRUE))

airbnb_tokens %>% 
  group_by(word) %>% 
  summarize(median_price = median(price),
            n = n()) %>% 
  arrange(desc(n)) %>% 
  head(30) %>% 
  mutate(word = fct_reorder(word, median_price)) %>% 
  ggplot(aes(word, median_price, fill = n)) +
  geom_col() +
  geom_text(aes(label = n), hjust = 1, color = "white", fontface = "bold") +
  scale_fill_gradient(low = "#6497b1", high = "#011f4b") +
  scale_y_continuous(labels = scales::dollar) +
  coord_flip()
```

```{r}
airbnb %>% 
  ggplot(aes(latitude,longitude, z = log(price))) + 
  stat_summary_hex(bins = 75) +
  scale_fill_paletteer_c("grDevices::Inferno") +
  theme_map()
```

```{r}
airbnb %>% 
  keep(is.numeric) %>% 
  cor(method = "spearman") %>% 
  ggcorrplot::ggcorrplot()
```

- Correlação entre as variáveis numéricas.  
- Imputação para reviews_per_month e extrair feature de last_review.  




