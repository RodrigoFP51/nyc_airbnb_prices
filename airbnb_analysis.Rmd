---
title: "NYC Airbnb Data Analysis"
author: "Rodrigo F. Pizzinato"
date: '`r format(Sys.Date(), "%d/%m/%Y")`'
output: 
  html_document:
  keep_md: true
  toc: true
  toc_depth: 2
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      error = FALSE, 
                      fig.width = 9)
```

```{r}
library(tidyverse)
library(here)
library(tidytext)
library(lubridate)
library(ppsr)
library(ggthemes)
library(DataExplorer)
library(paletteer)
library(patchwork)

theme_set(
  ggthemes::theme_gdocs()
)
```

O aluguel de acomodações através do Airbnb se tornou uma alternativa popular e conveniente para muitos viajantes. Com a crescente demanda por acomodações, é importante para os proprietários e locatários terem uma compreensão clara do mercado imobiliário para precificar adequadamente suas propriedades.

A ciência de dados pode ser aplicada ao mercado imobiliário do Airbnb para prever preços de aluguel com base em uma série de fatores, como localização, tamanho do imóvel, número de comodidades e disponibilidade sazonal. Essa previsão pode ajudar proprietários e locatários a estabelecer preços competitivos e aumentar sua receita.

Neste projeto de ciência de dados, exploraremos os dados do Airbnb e utilizaremos técnicas de análise exploratória de dados, visualização e modelagem preditiva para prever os preços de aluguel de propriedades do Airbnb. Através da análise desses dados, esperamos obter insights úteis sobre o mercado imobiliário do Airbnb e fornecer recomendações valiosas para proprietários e locatários de imóveis.


- Dados: [Kaggle](https://www.kaggle.com/c/sliced-s01e05-WXx7h8/data)  

```{r}
airbnb <- read_csv(here("Data/train.csv")) %>% 
  mutate(across(c(host_id, id), as.character))
```

## Dados faltantes
```{r}
airbnb %>% 
  plot_missing()
```

```{r}
airbnb %>% 
  visdat::vis_miss()
```


```{r}
skimr::skim(airbnb)
```

## distribuição das variáveis numéricas
```{r, fig.height=12}
g1 <- airbnb %>% 
  select(where(is.numeric), -price) %>% 
  pivot_longer(everything()) %>% 
  drop_na() %>% 
  ggplot(aes(value)) + 
  geom_histogram(fill = "#003366", color = "white", bins = 25, alpha = 0.75) +
  facet_wrap(vars(name), scales = "free") +
  labs(x='')

g2 <- airbnb %>% 
  ggplot(aes(price)) + 
  geom_histogram(fill = "#003366", color = "black", bins = 25, alpha = 0.75) +
  scale_x_continuous(labels = scales::dollar) +
  labs(x='')
  ggtitle("Price")

(g2 / g1) + patchwork::plot_annotation(title = "Distribution of Numerical Variables")
```

- Talvez o preço se beneficie com uma transformação logarítmica 

```{r}
g2 +
  scale_x_log10()

rm(g1,g2)
```

- Se assemelhou muito a uma distribuição normal, portanto usarei logaritmo para a modelagem e alguns gráficos.   

```{r}
# DresdenColor::paired
plot_grouped_distributions <- function(data,
                                       group,
                                       palette = "DresdenColor::paired"){
  data %>% 
  ggplot(aes(price+1, {{group}}, # + 1 pra não ter valores zerados no preço
             fill = factor(after_stat(quantile)))) + 
  ggridges::stat_density_ridges(
    geom = "density_ridges_gradient",
    quantiles = 4,
    quantile_lines = TRUE,
    alpha = 0.8
  ) +
  geom_vline(xintercept = median(data$price), 
             lty = 2,
             linewidth = 1.5, 
             alpha = 0.75,
             color = "gray40") +
  scale_fill_paletteer_d(palette, name = "Quartil") +
  scale_x_log10(labels = scales::dollar) +
  labs(x='', y='')
}

airbnb %>% 
  mutate(neighbourhood_group = fct_reorder(neighbourhood_group, price)) %>% 
  filter(between(price, 10, 1000)) %>% 
  plot_grouped_distributions(neighbourhood_group)

```
- Manhattan demonstra ter preços bem maiores, com seu primeiro quartil sendo maior que o último quartil de Bronx.  
- Staten Island e Queens tem distribuições bem parecidas.  
- A feature um bom potencial para ser incluído no modelo.  

```{r}
airbnb %>% 
  filter(between(price, 10, 1000)) %>% 
  plot_grouped_distributions(room_type)
```
- Diferente de `neighborhood group`, `room type` distingue melhor os preços.  
- Os quartos compartilhados, como esperado, são os mais baratos, enquanto a casa/apartamento inteiro tem um preço muito mais elevado.   

```{r}
airbnb %>% 
  filter(between(price, 10, 1000)) %>% 
  mutate(neighbourhood = fct_lump(neighbourhood, n = 9),
         neighbourhood = fct_reorder(neighbourhood, price)) %>% 
  plot_grouped_distributions(neighbourhood)
```
- Dado que existem `r n_distinct(airbnb$neighbourhood)` grupos diferentes na coluna `neighborhood` foi necessário fazer uma redução e colocar os grupos mais infrequentes como `outros`.  
- Hell's Kitchen, Upper West Side e East Village são as vizinhanças mais caras.  
- Pode ser uma variável preditora valiosa, mas deve ser utilizada apenas algumas categorias.  


## Predictive Power Score

```{r}
pps <- airbnb %>% 
  select(-name, -host_name, -ends_with("id")) %>% 
  mutate(neighbourhood = fct_lump(neighbourhood, n = 9)) %>% 
  drop_na() %>% 
  ppsr::score_predictors(y = "price") %>% 
  filter(!is.na(baseline_score))

corr_features <- corrr::correlate(airbnb, 
                                  use = "pairwise.complete.obs") %>% 
  select(corr = price, term) %>% 
  drop_na()

g1 <- pps %>% 
  mutate(x = fct_reorder(x, pps)) %>% 
  ggplot(aes(x,pps, fill = pps)) +
  geom_col() +
  scale_fill_gradient(low = "#6497b1", high = "#011f4b") +
  coord_flip() +
  labs(x='',y='') +
  ggtitle("Predictive Power Score")

g2 <- corr_features %>% 
  ggplot(aes(term, corr, fill = corr)) +
  geom_col() +
  scale_fill_gradient(low = "#6497b1", high = "#011f4b") +
  coord_flip() +
  ggtitle("Correlação: Pearson") +
  labs(x='',y='') 

(g1 / g2)
```
O Predictive Power Score é uma forma de estimar quais variáveis são importantes preditoras em um conjunto de dados. 

## Reviews

```{r}
airbnb_tokens <- airbnb %>% 
  unnest_tokens(word, name) %>% 
  anti_join(stop_words, by = "word") %>% 
  filter(str_detect(word, regex("^<U|[:digit:]"), negate = TRUE))

airbnb_tokens %>% 
  group_by(word) %>% 
  summarize(median_price = median(price),
            n = n()) %>%
  arrange(desc(n)) %>% 
  head(30) %>% 
  mutate(word = fct_reorder(word, median_price)) %>% 
  ggplot(aes(word, median_price, size = n)) +
  geom_point(pch = 18, size = 5, color = "darkblue") +
  #geom_text(aes(label = n), hjust = 1, color = "white", fontface = "bold") +
  scale_y_continuous(labels = scales::dollar) +
  coord_flip() +
  labs(x='', y='Preço mediano',
       title = "Preço associado a cada palavra da descrição") 
```

## Mapas e preço

```{r}
airbnb %>% 
  ggplot(aes(latitude,longitude, z = log(price))) + 
  stat_summary_hex(bins = 50) +
  scale_fill_paletteer_c("scico::bamako", direction = -1, name = "Log of Price")  +
  guides(fill = guide_colorbar(title.position = "top")) +
  labs(x='', y='',
       title = "") +
  theme(legend.direction = "horizontal", 
        legend.position = c(0.85,0.1), 
        legend.background = element_blank()) +
  theme_minimal()
```

```{r}
airbnb %>% 
  keep(is.numeric) %>% 
  cor(use = "pairwise.complete.obs") %>% 
  ggcorrplot::ggcorrplot(lab = TRUE)
```

```{r}
airbnb %>% 
  filter(price < 1000) %>% 
  drop_na() %>% 
  mutate(year = year(last_review),
         month = month(last_review, label = TRUE, abbr = TRUE)) %>% 
  select(price, year, month) %>%
  group_by(year,month) %>% 
  summarize(price = median(price),
            color = if_else(price < 100, "black", "white"),
            .groups = "drop") %>% 
  ggplot(aes(year, month, fill = price)) +
  geom_tile(linejoin = "round", color = "white") +
  geom_text(aes(label = scales::dollar(price), color = color),
            show.legend = FALSE,
            fontface = "bold") +
  scale_x_continuous(breaks = 2011:2019) +
  scale_color_manual(values = c("black","white")) +
  scale_fill_paletteer_c("scico::bamako",
                         name = "Price",
                         direction = -1) +
  theme_minimal() +
  labs(x='', y='',
       title = "Mediana do preço por ano e mês") + 
  theme(plot.title = element_text(hjust = 0.5, size = 18))

```

```{r}
airbnb_imputed <- airbnb %>% 
  as.data.frame() %>% 
  simputation::impute_knn(reviews_per_month ~ minimum_nights + number_of_reviews, k = 4) %>% 
  as_tibble() %>% 
  fill(last_review, .direction = "down") %>% 
  drop_na()

write_csv(airbnb_imputed, file = here("Data/airbnb_imputed"))
```






